<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>I FUCKING HATE COUNTS üí∞</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&family=JetBrains+Mono:wght@400;500;600&display=swap');

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-size: 400% 400%;
            animation: gradientShift 20s ease infinite;
            color: #1d1d1f;
            line-height: 1.6;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px 30px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            position: relative;
        }

        header::before {
            content: '';
            position: absolute;
            top: 2.5%;
            left: 20px;
            width: 200px;
            height: 95%;
            background-image: url('/static/logo.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: left center;
            opacity: 1.0;
            pointer-events: none;
        }

        header .header-top,
        header .subtitle,
        header .header-statement-tabs {
            position: relative;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .header-title {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            flex: 1;
        }


        h1 {
            font-size: 38.4px;
            font-weight: 900;
            background: linear-gradient(135deg, #FFD700, #FFA500, #FF6347);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
            letter-spacing: -1px;
            animation: titlePulse 3s ease-in-out infinite;
            filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.5));
        }

        @keyframes titlePulse {
            0%, 100% { transform: scale(1); filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.5)) brightness(1); }
            50% { transform: scale(1.05); filter: drop-shadow(0 0 30px rgba(255, 215, 0, 0.8)) brightness(1.2); }
        }

        .subtitle {
            color: rgba(255, 255, 255, 0.95);
            font-size: 16px;
            margin: 5px 0 15px 0;
            font-weight: 600;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .header-statement-tabs {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .upload-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .dropzone {
            background: white;
            border: 2px dashed #d1d1d6;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .dropzone:hover {
            border-color: #007aff;
            background: #f5f5f7;
        }

        .dropzone.dragging {
            border-color: #007aff;
            background: #e8f4fd;
        }

        .dropzone-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .dropzone-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        #receipts-dropzone .dropzone-title,
        #statement-dropzone .dropzone-title {
            font-size: 48px;
            font-weight: 900;
            letter-spacing: 2px;
        }

        .dropzone-subtitle {
            font-size: 14px;
            color: #86868b;
        }

        .dropzone input[type="file"] {
            display: none;
        }

        .statement-tabs {
            display: none; /* Hidden - tabs now in header */
        }

        .statement-tab {
            padding: 8px 16px;
            border: 1px solid #d1d1d6;
            background: white;
            color: #1d1d1f;
            cursor: pointer;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
            transition: all 0.2s;
            position: relative;
        }

        .statement-tab:hover {
            background: #f5f5f7;
            border-color: #007aff;
        }

        .statement-tab.active {
            background: #007aff;
            color: white;
            border-color: #007aff;
        }

        .statement-tab-label {
            display: inline-block;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }
        
        .stat-card:hover {
            transform: translateY(-5px) scale(1.03);
            box-shadow: 0 8px 30px rgba(102, 126, 234, 0.3);
        }

        .stat-card.completion-card {
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            position: relative;
            overflow: hidden;
            background-color: transparent;
            border: none;
            padding: 25px;
        }

        .stat-card.completion-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0);
            backdrop-filter: none;
            z-index: 0;
            transition: all 0.3s ease;
        }

        .stat-card.completion-card .stat-value,
        .stat-card.completion-card .stat-label,
        .stat-card.completion-card .learn-btn {
            position: relative;
            z-index: 1;
        }

        .stat-value {
            font-size: 43px;
            font-weight: 700;
            margin-bottom: 5px;
            font-family: 'JetBrains Mono', 'SF Mono', Monaco, monospace;
            letter-spacing: -0.5px;
        }

        .stat-value.matched { color: #34c759; }
        .stat-value.no-receipt { color: #ff9500; }
        .stat-value.missing { color: #ff3b30; }
        .stat-value.total { color: #007aff; }
        .stat-value.completion { color: #af52de; }
        
        /* Match label colors to stat values */
        .stat-card:has(.stat-value.matched) .stat-label { color: #34c759; }
        .stat-card:has(.stat-value.no-receipt) .stat-label { color: #ff9500; }
        .stat-card:has(.stat-value.missing) .stat-label { color: #ff3b30; }
        .stat-card:has(.stat-value.total) .stat-label { color: #007aff; }
        .stat-card:has(.stat-value.completion) .stat-label { color: #af52de; }

        .stat-label {
            color: #86868b;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: white;
            padding: 10px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .tab {
            padding: 10px 20px;
            border: none;
            background: transparent;
            color: #1d1d1f;
            cursor: pointer;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .tab:hover {
            background: #f5f5f7;
        }

        .tab.active {
            background: #007aff;
            color: white;
        }

        .content-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 15px 10px;
            border-bottom: 2px solid #f5f5f7;
            font-size: 12px;
            font-weight: 600;
            color: #86868b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 15px 10px;
            border-bottom: 1px solid #f5f5f7;
            font-size: 14px;
        }

        tr:hover {
            background: #fafafa;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge.matched {
            background: #e8f5e9;
            color: #34c759;
        }

        .badge.unmatched {
            background: #ffebee;
            color: #ff3b30;
        }

        .badge.no-receipt {
            background: #fff4e6;
            color: #ff9500;
        }

        .checkbox-cell {
            text-align: center;
        }

        .checkbox-cell input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #ff9500;
        }

        tr.no-receipt-row {
            opacity: 0.6;
        }

        .receipt-name {
            color: #86868b;
            font-size: 12px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #86868b;
        }

        .spinner {
            border: 3px solid #f5f5f7;
            border-top: 3px solid #007aff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .amount {
            font-family: 'JetBrains Mono', 'SF Mono', Monaco, monospace;
            font-weight: 500;
            letter-spacing: -0.3px;
            font-size: 13px;
        }

        .amount.negative {
            color: #ff3b30;
        }

        .amount.positive {
            color: #34c759;
        }

        .description {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: pointer;
            color: #1d1d1f;
            transition: color 0.2s;
        }

        .description:hover {
            color: #007aff;
        }

        .description-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .description-modal.show {
            display: flex;
        }

        .viewer-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .viewer-modal.show {
            display: flex;
        }

        .viewer-content {
            width: 90%;
            height: 90%;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .viewer-header {
            padding: 20px;
            background: #f5f5f7;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #d2d2d7;
        }

        .viewer-title {
            font-size: 16px;
            font-weight: 600;
            color: #1d1d1f;
        }

        .viewer-close {
            padding: 8px 16px;
            background: #ff3b30;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .viewer-close:hover {
            background: #ff2d1f;
        }

        .viewer-body {
            flex: 1;
            overflow: auto;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f5f5f7;
        }

        .viewer-body iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .viewer-body img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #1d1d1f;
        }

        .modal-body {
            font-size: 14px;
            line-height: 1.8;
            color: #1d1d1f;
            word-wrap: break-word;
            font-family: 'JetBrains Mono', monospace;
            background: #f5f5f7;
            padding: 15px;
            border-radius: 8px;
        }

        .modal-close {
            margin-top: 20px;
            padding: 10px 20px;
            background: #007aff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .modal-close:hover {
            background: #0051d5;
        }

        /* Drag over styling for table rows */
        tr.drag-over {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            border: 2px dashed #FFD700 !important;
            transform: scale(1.02);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        tr {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        tr:hover {
            transform: translateX(5px);
            box-shadow: -5px 0 15px rgba(102, 126, 234, 0.2);
        }
        
        /* Badge animations */
        .badge {
            animation: badgePulse 2s ease-in-out infinite;
        }
        
        @keyframes badgePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .badge.matched {
            animation: matchedGlow 2s ease-in-out infinite;
        }
        
        @keyframes matchedGlow {
            0%, 100% { box-shadow: 0 0 5px rgba(52, 199, 89, 0.5); }
            50% { box-shadow: 0 0 15px rgba(52, 199, 89, 0.8); }
        }

        /* Ownership buttons */
        .ownership-buttons-container {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .ownership-btn {
            padding: 6px 12px;
            border: 2px solid #d1d1d6;
            border-radius: 8px;
            background: white;
            color: #86868b;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .ownership-btn:hover:not(.disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .ownership-btn.active {
            background: linear-gradient(135deg, #ff3b30 0%, #ff6b60 100%);
            border-color: #ff3b30;
            color: white;
            box-shadow: 0 4px 12px rgba(255, 59, 48, 0.3);
        }

        .ownership-btn.disabled {
            opacity: 0.4;
            cursor: not-allowed;
            pointer-events: none;
        }
        
        th.center-header {
            text-align: center !important;
        }

        /* Receipt delete button */
        .receipt-cell {
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: space-between;
        }

        .receipt-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .delete-receipt-btn {
            padding: 4px 8px;
            background: #ff3b30;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .delete-receipt-btn:hover {
            background: #d72c24;
            transform: scale(1.05);
        }

        .merchant-short {
            font-weight: 500;
        }

        .invoice-btn {
            display: inline-block;
            margin-left: 8px;
            padding: 4px 10px;
            background: linear-gradient(135deg, #007aff 0%, #0051d5 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s ease;
            vertical-align: middle;
        }

        .invoice-btn:hover {
            background: linear-gradient(135deg, #0051d5 0%, #007aff 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 122, 255, 0.3);
        }

        .learn-url-btn {
            display: inline-block;
            margin-left: 8px;
            padding: 4px 10px;
            background: linear-gradient(135deg, #ff9500 0%, #ff8800 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s ease;
            vertical-align: middle;
        }

        .learn-url-btn:hover {
            background: linear-gradient(135deg, #ff8800 0%, #ff9500 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(255, 149, 0, 0.3);
        }

        .edit-url-btn {
            display: inline-block;
            margin-left: 4px;
            padding: 4px 8px;
            background: rgba(0, 122, 255, 0.1);
            color: #007aff;
            border: 1px solid rgba(0, 122, 255, 0.3);
            border-radius: 6px;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s ease;
            vertical-align: middle;
        }

        .edit-url-btn:hover {
            background: rgba(0, 122, 255, 0.2);
            border-color: #007aff;
            transform: translateY(-1px);
        }

        .refresh-btn {
            background: #007aff;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: background 0.2s;
            white-space: nowrap;
        }

        .refresh-btn:hover {
            background: #0051d5;
        }
        
        .refresh-btn:disabled {
            background: #d1d1d6;
            cursor: not-allowed;
        }

        .update-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 16px 40px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: all 0.3s;
            min-width: 300px;
        }

        .update-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .update-btn:disabled {
            background: #d1d1d6;
            cursor: not-allowed;
            box-shadow: none;
        }

        .update-btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .clear-btn {
            background: #ff9500;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            min-width: 180px;
        }

        .clear-btn:hover:not(:disabled) {
            background: #ff8800;
            transform: translateY(-1px);
        }

        .clear-btn:disabled {
            background: #d1d1d6;
            cursor: not-allowed;
        }

        .delete-btn {
            background: #ff3b30;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            min-width: 180px;
        }

        .delete-btn:hover:not(:disabled) {
            background: #d72c24;
            transform: translateY(-1px);
        }

        .delete-btn:disabled {
            background: #d1d1d6;
            cursor: not-allowed;
        }

        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin: 30px 0 20px 0;
        }

        .learn-btn {
            background: linear-gradient(135deg, #34c759 0%, #30d158 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            min-width: 180px;
            box-shadow: 0 4px 15px rgba(52, 199, 89, 0.3);
        }

        .learn-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #30d158 0%, #34c759 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 199, 89, 0.5);
        }

        .learn-btn:disabled {
            background: #d1d1d6;
            cursor: not-allowed;
            box-shadow: none;
        }

        .header-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 20px;
            max-width: 280px;
        }

        .file-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .file-item {
            padding: 12px;
            border-bottom: 1px solid #f5f5f7;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-item:hover {
            background: #fafafa;
        }

        .file-name {
            font-size: 14px;
            font-weight: 500;
        }

        .file-meta {
            font-size: 12px;
            color: #86868b;
        }

        .download-link {
            color: #007aff;
            text-decoration: none;
            font-size: 12px;
        }

        .download-link:hover {
            text-decoration: underline;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: none;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .toast.success {
            border-left: 4px solid #34c759;
        }

        .toast.error {
            border-left: 4px solid #ff3b30;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-top">
                <div class="header-title">
                    <h1>üí∞ I FUCKING HATE COUNTS üí∞</h1>
                </div>
                <div class="header-actions">
                    <button class="refresh-btn" onclick="exportLearnedUrls()" title="Export learned invoice URLs">üì• Export URLs</button>
                    <button class="refresh-btn" onclick="importLearnedUrls()" title="Import learned invoice URLs">üì§ Import URLs</button>
                    <button class="refresh-btn" onclick="loadAll()">üîÑ Refresh</button>
                    <button class="refresh-btn" onclick="undoLastAction()" id="header-undo-btn" disabled>‚Ü∂ Undo</button>
                </div>
            </div>
            <p class="subtitle">Because finding receipts fucking sucks!</p>
            <div class="header-statement-tabs" id="header-statement-tabs">
                <div class="loading" style="font-size: 13px; color: #86868b;">Loading statements...</div>
            </div>
        </header>

        <div class="upload-section">
            <div class="dropzone" id="statement-dropzone" onclick="document.getElementById('statement-input').click()">
                <div class="dropzone-title">DROP STATEMENT</div>
                <div class="dropzone-subtitle">Drop CSV/Excel file or click to browse</div>
                <input type="file" id="statement-input" accept=".csv,.xlsx,.xls" onchange="uploadStatement(this)">
            </div>

            <div class="dropzone" id="receipts-dropzone" onclick="document.getElementById('receipts-input').click()">
                <div class="dropzone-title">DROP RECEIPTS</div>
                <div class="dropzone-subtitle">Drop PDF files or click to browse</div>
                <input type="file" id="receipts-input" accept=".pdf" multiple onchange="uploadReceipts(this)">
            </div>
        </div>

        <div class="action-buttons">
            <button id="update-btn" class="update-btn" onclick="runMatching()" disabled>
                <span id="update-btn-text">üîÑ UPDATE - Match Receipts</span>
                <span id="update-btn-spinner" style="display: none;">‚è≥ Processing...</span>
            </button>
            <button id="clear-btn" class="clear-btn" onclick="clearStatement()" disabled>
                üîÑ CLEAR - Reset Statement
            </button>
            <button id="delete-btn" class="delete-btn" onclick="deleteStatement()" disabled>
                üóëÔ∏è DELETE - Remove Statement
            </button>
        </div>
        <div id="match-progress" style="margin-top: 10px; text-align: center; font-size: 14px; color: #86868b;"></div>

        <!-- Statement tabs moved to header -->

        <div class="folder-links" id="folder-links" style="display: none; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px;">
            <div style="font-size: 12px; font-weight: 600; color: #86868b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px;">Statement Folders</div>
            <div style="display: flex; gap: 15px;">
                <a id="receipts-folder-link" href="#" style="color: #007aff; text-decoration: none; font-size: 14px;">üìÅ Receipts Folder</a>
                <a id="matched-folder-link" href="#" style="color: #007aff; text-decoration: none; font-size: 14px;">üìÅ Matched Receipts</a>
            </div>
        </div>

        <div class="stats-grid" id="stats">
            <div class="stat-card">
                <div class="stat-value total" id="stat-total">-</div>
                <div class="stat-label">Total Transactions</div>
            </div>
            <div class="stat-card">
                <div class="stat-value matched" id="stat-matched">-</div>
                <div class="stat-label">Matched</div>
            </div>
            <div class="stat-card">
                <div class="stat-value no-receipt" id="stat-no-receipt">-</div>
                <div class="stat-label">No Receipt Needed</div>
            </div>
            <div class="stat-card">
                <div class="stat-value missing" id="stat-missing">-</div>
                <div class="stat-label">Missing Receipts</div>
            </div>
            <div class="stat-card completion-card" id="completion-card" style="position: relative;">
                <div class="stat-value completion" id="stat-completion">-</div>
                <div class="stat-label">Completion %</div>
                <button id="learn-btn-card" class="learn-btn" onclick="updateLearning()" disabled style="display: none; position: absolute; right: 20px; top: 50%; transform: translateY(-50%); min-width: auto; padding: 8px 16px; font-size: 12px;">
                    üß† Learn
                </button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('all', this)">All Transactions</button>
            <button class="tab" onclick="switchTab('matched', this)">Matched Only</button>
            <button class="tab" onclick="switchTab('unmatched', this)">Unmatched Only</button>
            <button class="tab" onclick="switchTab('receipts', this)">Receipts in Folder</button>
            <button class="tab" onclick="switchTab('renamed', this)">Renamed Receipts</button>
            <button class="tab" onclick="switchTab('pool', this)">üì¶ Receipt Pool</button>
        </div>

        <div class="content-section" id="transactions-section">
            <div class="loading" id="loading">
                <div class="spinner"></div>
                Loading data...
            </div>
            <div id="transactions-table" style="display: none;">
                <table>
                    <thead>
                        <tr>
                            <th>Row</th>
                            <th>Date</th>
                            <th>Amount</th>
                            <th>Description</th>
                            <th>Status</th>
                            <th class="center-header">Private</th>
                            <th>No Receipt</th>
                            <th>Receipt</th>
                        </tr>
                    </thead>
                    <tbody id="transactions-body">
                    </tbody>
                </table>
            </div>
        </div>

        <div class="content-section" id="receipts-section" style="display: none;">
            <h2 style="margin-bottom: 20px;">Receipts in Folder</h2>
            <div class="file-list" id="receipts-list"></div>
        </div>

        <div class="content-section" id="renamed-section" style="display: none;">
            <h2 style="margin-bottom: 20px;">Renamed Receipts</h2>
            <div class="file-list" id="renamed-list"></div>
        </div>

        <div class="content-section" id="pool-section" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">üì¶ Receipt Pool</h2>
                <input type="text" id="pool-search" placeholder="Search receipts..." 
                       style="padding: 8px 12px; border: 1px solid #d1d1d6; border-radius: 8px; width: 300px; font-size: 14px;"
                       oninput="filterPool()">
            </div>
            <p style="color: #86868b; margin-bottom: 15px; font-size: 14px;">
                Receipts you've moved to the pool. These can be assigned to any statement.
            </p>
            <div class="file-list" id="pool-list"></div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <div class="description-modal" id="description-modal">
        <div class="modal-content">
            <div class="modal-header">Transaction Description</div>
            <div class="modal-body" id="modal-description"></div>
            <button class="modal-close" onclick="closeDescriptionModal()">Close</button>
        </div>
    </div>

    <!-- Replace Receipt Modal -->
    <div class="description-modal" id="replace-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">Replace Existing Receipt</div>
            <div class="modal-body" id="replace-message" style="margin-bottom: 20px;"></div>
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button id="replace-delete-btn" class="modal-close" style="background: #ff3b30;">Replace & Delete</button>
                <button id="replace-restore-btn" class="modal-close" style="background: #ff9500;">Replace & Restore</button>
                <button id="replace-cancel-btn" class="modal-close" style="background: #86868b;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Learn Invoice URL Modal -->
    <div class="description-modal" id="learn-url-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header" id="learn-url-modal-header">Learn Invoice URL</div>
            <div class="modal-body" style="margin-bottom: 20px;">
                <p style="margin-bottom: 15px;"><span id="learn-url-action">Add an</span> invoice/billing URL for <strong id="learn-merchant-name"></strong></p>
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Invoice URL:</label>
                <input type="url" id="learn-url-input" placeholder="https://example.com/billing" 
                       style="width: 100%; padding: 10px; border: 1px solid #d1d1d6; border-radius: 6px; font-size: 14px; margin-bottom: 10px;">
                <p style="font-size: 12px; color: #86868b;">This URL will be saved for future transactions from this merchant.</p>
            </div>
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button id="learn-url-save-btn" class="modal-close" style="background: #007aff;">Save URL</button>
                <button id="learn-url-cancel-btn" class="modal-close" style="background: #86868b;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Receipt Viewer Modal -->
    <div class="viewer-modal" id="viewer-modal">
        <div class="viewer-content">
            <div class="viewer-header">
                <div class="viewer-title" id="viewer-filename">Receipt Viewer</div>
                <button class="viewer-close" onclick="closeViewer()">Close</button>
            </div>
            <div class="viewer-body" id="viewer-body"></div>
        </div>
    </div>

    <script>
        let currentFilter = 'all';
        let currentStatement = null;

        // Merchant invoice URL mapping
        const merchantInvoiceUrls = {
            'vodafone': 'https://www.vodafone.de/meinkabel/rechnungen',
            'google': 'https://pay.google.com/gp/w/home/activity',
            'paypal': 'https://www.paypal.com/myaccount/transactions',
            'amazon': 'https://www.amazon.de/gp/your-account/order-history',
            'amzn': 'https://www.amazon.de/gp/your-account/order-history',
            'prime': 'https://www.amazon.de/gp/your-account/order-history',
            'ebay': 'https://www.ebay.de/mye/myebay/purchase',
            'spotify': 'https://www.spotify.com/de/account/subscription/',
            'netflix': 'https://www.netflix.com/BillingActivity',
            'apple': 'https://reportaproblem.apple.com/',
            'microsoft': 'https://account.microsoft.com/billing/orders',
            'telekom': 'https://geschaeftskunden.telekom.de/kundencenter/rechnungen',
            'o2': 'https://www.o2online.de/mein-o2/rechnungen/',
            'ionos': 'https://my.ionos.de/account/billing',
            'strato': 'https://www.strato.de/apps/CustomerService',
            'aws': 'https://console.aws.amazon.com/billing/',
            'azure': 'https://portal.azure.com/#view/Microsoft_Azure_GTM/ModernBillingMenuBlade/~/Overview',
            'digitalocean': 'https://cloud.digitalocean.com/billing',
            'github': 'https://github.com/settings/billing',
            'stripe': 'https://dashboard.stripe.com/invoices',
            'payoneer': 'https://myaccount.payoneer.com/ma/billing/statements',
            'wise': 'https://wise.com/user/account/statements',
            'n26': 'https://app.n26.com/transactions',
            'revolut': 'https://app.revolut.com/',
            'rabot': 'https://www.rabot-charge.de/login',
            'lidl': 'https://www.lidl.de/rechnung',
            'rewe': 'https://shop.rewe.de/order-history',
            'dm': 'https://www.dm.de/mein-dm/bestellungen',
            'zalando': 'https://www.zalando.de/myaccount/orders/',
        };

        // Load learned URLs from localStorage
        let learnedMerchantUrls = {};
        
        async function loadLearnedUrls() {
            // Try to load from server file first
            try {
                const response = await fetch('/api/learned-urls');
                if (response.ok) {
                    const serverUrls = await response.json();
                    if (Object.keys(serverUrls).length > 0) {
                        learnedMerchantUrls = serverUrls;
                        // Sync to localStorage
                        localStorage.setItem('learnedMerchantUrls', JSON.stringify(learnedMerchantUrls));
                        console.log('‚úÖ Loaded learned URLs from server file');
                        return;
                    }
                }
            } catch (e) {
                console.warn('Could not load from server, falling back to localStorage:', e);
            }
            
            // Fallback to localStorage
            const stored = localStorage.getItem('learnedMerchantUrls');
            if (stored) {
                try {
                    learnedMerchantUrls = JSON.parse(stored);
                } catch (e) {
                    console.error('Error loading learned URLs:', e);
                    learnedMerchantUrls = {};
                }
            }
        }
        
        async function saveLearnedUrls() {
            // Save to localStorage
            localStorage.setItem('learnedMerchantUrls', JSON.stringify(learnedMerchantUrls));
            
            // Save to server file for persistence
            try {
                const response = await fetch('/api/learned-urls', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(learnedMerchantUrls)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Saved to server:', result.message);
                } else {
                    console.warn('Failed to save to server, but localStorage is updated');
                }
            } catch (e) {
                console.warn('Could not save to server, but localStorage is updated:', e);
            }
        }
        
        async function exportLearnedUrls() {
            const dataStr = JSON.stringify(learnedMerchantUrls, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'learned_invoice_urls.json';
            link.click();
            URL.revokeObjectURL(url);
            showToast('Exported learned URLs! üì•', 'success');
        }
        
        async function importLearnedUrls() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    const text = await file.text();
                    const imported = JSON.parse(text);
                    
                    // Merge with existing URLs
                    const count = Object.keys(imported).length;
                    learnedMerchantUrls = { ...learnedMerchantUrls, ...imported };
                    await saveLearnedUrls();
                    
                    showToast(`Imported ${count} learned URLs! üì§`, 'success');
                    loadTransactions(currentFilter);
                } catch (err) {
                    showToast('Failed to import: Invalid JSON file', 'error');
                    console.error('Import error:', err);
                }
            };
            input.click();
        }
        
        function getMerchantInvoiceUrl(merchantName) {
            if (!merchantName) return null;
            
            const normalized = merchantName.toLowerCase().trim();
            
            // Check learned URLs first (user-defined takes priority)
            for (const [key, url] of Object.entries(learnedMerchantUrls)) {
                if (normalized.includes(key.toLowerCase())) {
                    return url;
                }
            }
            
            // Then check built-in URLs
            for (const [key, url] of Object.entries(merchantInvoiceUrls)) {
                if (normalized.includes(key)) {
                    return url;
                }
            }
            
            return null;
        }
        
        function showLearnUrlModal(merchantName, currentUrl = '') {
            const modal = document.getElementById('learn-url-modal');
            const modalHeader = document.getElementById('learn-url-modal-header');
            const actionText = document.getElementById('learn-url-action');
            const merchantNameEl = document.getElementById('learn-merchant-name');
            const urlInput = document.getElementById('learn-url-input');
            const saveBtn = document.getElementById('learn-url-save-btn');
            const cancelBtn = document.getElementById('learn-url-cancel-btn');
            
            // Update modal text based on whether we're editing or adding
            if (currentUrl) {
                modalHeader.textContent = 'Edit Invoice URL';
                actionText.textContent = 'Update the';
            } else {
                modalHeader.textContent = 'Learn Invoice URL';
                actionText.textContent = 'Add an';
            }
            
            merchantNameEl.textContent = merchantName;
            urlInput.value = currentUrl;
            
            saveBtn.onclick = () => {
                const url = urlInput.value.trim();
                if (!url) {
                    showToast('Please enter a URL', 'error');
                    return;
                }
                
                // Validate URL
                try {
                    new URL(url);
                } catch (e) {
                    showToast('Please enter a valid URL (e.g., https://example.com)', 'error');
                    return;
                }
                
                // Save to learned URLs
                learnedMerchantUrls[merchantName] = url;
                saveLearnedUrls();
                
                showToast(`${currentUrl ? 'Updated' : 'Learned'} URL for ${merchantName}! üéì`, 'success');
                modal.style.display = 'none';
                
                // Reload transactions to show the new button
                loadTransactions(currentFilter);
            };
            
            cancelBtn.onclick = () => {
                modal.style.display = 'none';
            };
            
            modal.style.display = 'flex';
            urlInput.focus();
        }
        
        // Load learned URLs on startup
        loadLearnedUrls();

        function extractMerchant(description) {
            // Extract merchant name from transaction description
            if (!description) return 'Unknown';
            
            // Skip internal bank transactions
            if (description.match(/^(Abschluss|Umsatzsteuer|MASTERCARD Abrechnung)/i)) {
                return ''; // Return empty to hide Learn URL button
            }
            
            // Pattern 1: "Ihr Einkauf bei [Merchant]" (PayPal format) - check FIRST
            let match = description.match(/Ihr Einkauf bei\s+([^,\s]+(?:\s+[^,\s]+)?)/i);
            if (match) return match[1].trim();
            
            // Pattern 2: Amazon order numbers - extract AMZN/Prime
            if (description.match(/AMZN\s+Mktp/i)) return 'Amazon';
            if (description.match(/AMZNPrime/i)) return 'Amazon Prime';
            if (description.match(/Prime\s+Video/i)) return 'Amazon Prime Video';
            
            // Pattern 3: "bei www.merchant.de" or "online bei merchant"
            match = description.match(/(?:online\s+)?bei\s+(?:www\.)?([a-z0-9-]+)(?:\.|\/)/i);
            if (match) return match[1];
            
            // Pattern 4: PayPal with transaction ID - clean it up
            match = description.match(/^\d+\/(?:PP\.\d+\.)?PP\/\.\s+([^,]+?)(?:\s*,|\s*EREF|$)/i);
            if (match) return match[1].trim();
            
            // Pattern 5: "digits/. Merchant" format (non-PayPal)
            match = description.match(/^\d+\/\.\s+([^,]+?)(?:\s*,|\s*EREF|$)/i);
            if (match) return match[1].trim();
            
            // Pattern 6: Look for merchant before "EREF" or similar references
            match = description.match(/^([^\/]+?)(?:\s+EREF|\s+MREF|\s+CRED|\s+IBAN)/i);
            if (match) {
                let merchant = match[1].trim();
                
                // Skip if starts with order number pattern (D01-xxx or xxx-xxx-xxx)
                if (merchant.match(/^[A-Z]\d{2}-\d+|^\d{3}-\d{7}/)) {
                    // Try to find merchant after order number
                    const parts = merchant.split(/\s+/);
                    merchant = parts.slice(1).join(' ');
                }
                
                // Clean up common prefixes
                merchant = merchant.replace(/^(\d{2,}\/\d{4}\s+|K-NR\.\s+\d+\s+|Rechnung-Nr\.:\s*\S+\s+)/i, '');
                
                // Look for "bei [merchant]" within this text
                const beiMatch = merchant.match(/bei\s+([a-zA-Z0-9]+)/i);
                if (beiMatch) return beiMatch[1];
                
                // Take first meaningful words (max 2)
                const words = merchant.split(/\s+/).filter(w => w.length > 2 && !w.match(/^\d+$/) && !w.match(/^[\d-]+$/));
                return words.slice(0, 2).join(' ') || merchant.substring(0, 30);
            }
            
            // Fallback: Take first meaningful words
            const words = description.split(/\s+/);
            const merchant = [];
            
            for (let i = 0; i < Math.min(words.length, 5); i++) {
                const word = words[i];
                
                // Stop at reference codes
                if (word.match(/^(EREF|MREF|CRED|IBAN|BIC|Mandatsreferenz|SVWZ)/i)) break;
                
                // Skip: dates, pure numbers, order IDs, very short words
                if (word.match(/^\d{1,2}[\.\/]\d{1,2}/) || word.match(/^\d+$/) || word.match(/^[A-Z]\d{2}-/) || word.length <= 2) continue;
                
                // Skip common German transaction words
                if (word.match(/^(von|f√ºr|per|am|zum|zur|der|die|das|Abrechnung|Abschluss)$/i)) continue;
                
                merchant.push(word);
                if (merchant.length >= 2) break;
            }
            
            return merchant.join(' ') || description.substring(0, 30);
        }

        function showDescriptionModal(fullDescription) {
            document.getElementById('modal-description').textContent = fullDescription;
            document.getElementById('description-modal').classList.add('show');
        }

        function closeDescriptionModal() {
            document.getElementById('description-modal').classList.remove('show');
        }

        function viewReceipt(filepath, filename) {
            const modal = document.getElementById('viewer-modal');
            const body = document.getElementById('viewer-body');
            const title = document.getElementById('viewer-filename');
            
            title.textContent = filename;
            
            // Determine file type and create appropriate viewer
            const ext = filename.split('.').pop().toLowerCase();
            
            if (ext === 'pdf') {
                body.innerHTML = `<iframe src="/api/view/${filepath}"></iframe>`;
            } else if (['png', 'jpg', 'jpeg', 'gif'].includes(ext)) {
                body.innerHTML = `<img src="/api/view/${filepath}" alt="${filename}">`;
            } else {
                body.innerHTML = `<p style="padding: 40px; text-align: center;">Preview not available for this file type</p>`;
            }
            
            modal.classList.add('show');
        }

        function closeViewer() {
            const modal = document.getElementById('viewer-modal');
            modal.classList.remove('show');
            document.getElementById('viewer-body').innerHTML = '';
        }

        async function deleteReceipt(filepath, filename) {
            // Show choice dialog
            const choice = confirm(`What would you like to do with "${filename}"?\n\nOK = Move to Pool (can use later)\nCancel = Delete Permanently`);
            
            const action = choice ? 'pool' : 'delete';
            
            if (!choice) {
                // Permanent delete - extra confirmation
                const confirmDelete = confirm(`‚ö†Ô∏è WARNING: This will PERMANENTLY delete "${filename}"!\n\nThis cannot be undone. Are you sure?`);
                if (!confirmDelete) {
                    return; // User cancelled
                }
            }
            
            try {
                const response = await fetch('/api/delete-receipt', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filepath, action })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast(data.message, 'success');
                    loadAll(); // Reload everything
                } else {
                    showToast(data.error || 'Failed to delete receipt', 'error');
                }
            } catch (error) {
                console.error('Error deleting receipt:', error);
                showToast('Error deleting receipt', 'error');
            }
        }

        // Close modal on background click
        document.getElementById('description-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeDescriptionModal();
            }
        });

        // Close modal on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeDescriptionModal();
                document.getElementById('replace-modal').style.display = 'none';
                document.getElementById('learn-url-modal').style.display = 'none';
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + U = Undo
            if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
                e.preventDefault();
                const undoBtn = document.getElementById('undo-btn');
                if (!undoBtn.disabled) {
                    undoLastAction();
                }
            }
            
            // Ctrl/Cmd + Enter = Run matching
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                const updateBtn = document.getElementById('update-btn');
                if (!updateBtn.disabled) {
                    runMatching();
                }
            }
            
            // Ctrl/Cmd + R = Reload all data
            if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
                e.preventDefault();
                if (currentStatement) {
                    loadAll();
                    showToast('Data refreshed', 'success');
                }
            }
            
            // Tab switching with numbers
            if (e.key >= '1' && e.key <= '5') {
                const tabs = document.querySelectorAll('.tab');
                const index = parseInt(e.key) - 1;
                if (tabs[index]) {
                    tabs[index].click();
                }
            }
        });
        
        // Show keyboard shortcuts hint
        console.log('%cüí∞ SWEET DUDE SWEET - Keyboard Shortcuts:', 'font-size: 16px; font-weight: bold; color: #FFD700;');
        console.log('%cCtrl/Cmd + Z: Undo last assignment', 'color: #667eea;');
        console.log('%cCtrl/Cmd + Enter: Run matching', 'color: #667eea;');
        console.log('%cCtrl/Cmd + R: Refresh data', 'color: #667eea;');
        console.log('%c1-5: Switch tabs', 'color: #667eea;');
        console.log('%cEsc: Close modals', 'color: #667eea;');

        // Drag and drop for statement
        function setupStatementDropzone() {
            const statementDropzone = document.getElementById('statement-dropzone');
            if (!statementDropzone) return;
            
            statementDropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                statementDropzone.classList.add('dragging');
            });
            
            statementDropzone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                e.stopPropagation();
                statementDropzone.classList.remove('dragging');
            });
            
            statementDropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                statementDropzone.classList.remove('dragging');
                
                const files = e.dataTransfer.files;
                console.log('Statement files dropped:', files);
                
                if (files.length > 0) {
                    handleStatementUpload(files[0]);
                } else {
                    showToast('No file detected', 'error');
                }
            });
        }
        
        setupStatementDropzone();

        // Drag and drop for receipts
        function setupReceiptsDropzone() {
            const receiptsDropzone = document.getElementById('receipts-dropzone');
            if (!receiptsDropzone) return;
            
            receiptsDropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                receiptsDropzone.classList.add('dragging');
            });
            
            receiptsDropzone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                e.stopPropagation();
                receiptsDropzone.classList.remove('dragging');
            });
            
            receiptsDropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                receiptsDropzone.classList.remove('dragging');
                
                const files = e.dataTransfer.files;
                console.log('Receipt files dropped:', files);
                
                if (files.length > 0) {
                    handleReceiptsUpload(files);
                } else {
                    showToast('No files detected', 'error');
                }
            });
        }
        
        setupReceiptsDropzone();

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }

        function updateCompletionBackground(completionRate) {
            const card = document.getElementById('completion-card');
            let imageNumber = 1;
            
            if (completionRate < 20) {
                imageNumber = 1;
            } else if (completionRate < 40) {
                imageNumber = 2;
            } else if (completionRate < 60) {
                imageNumber = 3;
            } else if (completionRate < 80) {
                imageNumber = 4;
            } else if (completionRate < 100) {
                imageNumber = 5;
            } else {
                imageNumber = 6;
            }
            
            card.style.backgroundImage = `url('/static/images/${imageNumber}.png')`;
            
            // Adjust overlay opacity - more transparent as completion increases
            const overlay = window.getComputedStyle(card, '::before');
            card.style.setProperty('--overlay-opacity', '0.3');
        }

        async function uploadStatement(input) {
            // Restrict to single file only
            if (input.files.length > 1) {
                showToast('Please upload only one statement file at a time', 'error');
                input.value = ''; // Clear the input
                return;
            }
            
            if (input.files.length > 0) {
                await handleStatementUpload(input.files[0]);
            }
        }

        async function handleStatementUpload(file) {
            console.log('Uploading statement file:', file.name, file.type, file.size);
            
            // Prompt for label/name for this statement
            const defaultLabel = file.name.replace(/\.(csv|xlsx|xls)$/i, '');
            const label = prompt(`Enter a label for this statement:\n(Leave blank to use filename)`, defaultLabel);
            
            // If user cancelled the prompt, abort upload
            if (label === null) {
                showToast('Upload cancelled', 'error');
                return;
            }
            
            const finalLabel = label.trim() || defaultLabel;
            
            const formData = new FormData();
            formData.append('file', file);

            try {
                showToast('Uploading statement...', 'success');
                
                const response = await fetch('/api/upload/statement', {
                    method: 'POST',
                    body: formData
                });
                
                console.log('Upload response status:', response.status);
                const data = await response.json();
                console.log('Upload response data:', data);
                
                if (data.success) {
                    // Save the label to localStorage
                    localStorage.setItem(`statement_label_${data.filename}`, finalLabel);
                    
                    showToast(data.message, 'success');
                    await loadStatements();
                    loadAll();
                } else {
                    showToast(data.error || 'Upload failed', 'error');
                }
            } catch (error) {
                console.error('Error uploading statement:', error);
                showToast('Upload failed: ' + error.message, 'error');
            }
        }

        async function uploadReceipts(input) {
            if (input.files.length > 0) {
                await handleReceiptsUpload(input.files);
            }
        }

        async function handleReceiptsUpload(files) {
            if (!currentStatement) {
                showToast('Please select a statement first', 'error');
                return;
            }
            
            const formData = new FormData();
            for (let file of files) {
                formData.append('files', file);
            }
            formData.append('statement', currentStatement);

            try {
                const response = await fetch('/api/upload/receipt', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                
                if (data.success) {
                    showToast(data.message, 'success');
                    loadAll();
                } else {
                    showToast(data.error || 'Upload failed', 'error');
                }
            } catch (error) {
                console.error('Error uploading receipts:', error);
                showToast('Upload failed', 'error');
            }
        }

        let currentStatementData = null;

        async function loadStatements() {
            try {
                const response = await fetch('/api/statements');
                const statements = await response.json();
                
                // Render tabs in header instead of old location
                const tabsContainer = document.getElementById('header-statement-tabs');
                tabsContainer.innerHTML = '';
                
                if (statements.length === 0) {
                    tabsContainer.innerHTML = '<p style="color: #86868b; font-size: 13px;">No statements uploaded yet</p>';
                    document.getElementById('folder-links').style.display = 'none';
                    return;
                }
                
                statements.forEach((statement, index) => {
                    const btn = document.createElement('button');
                    btn.className = 'statement-tab' + (index === 0 ? ' active' : '');
                    
                    // Get label from localStorage or use filename
                    const label = localStorage.getItem(`statement_label_${statement.name}`) || statement.name.replace(/\.(csv|xlsx|xls)$/i, '');
                    
                    const labelSpan = document.createElement('span');
                    labelSpan.className = 'statement-tab-label';
                    labelSpan.textContent = label;
                    btn.title = `${statement.name}\nDouble-click to open folder`; // Show full filename and hint on hover
                    
                    btn.appendChild(labelSpan);
                    btn.onclick = () => selectStatement(statement, btn);
                    btn.ondblclick = async () => {
                        // Double-click to open statement folder
                        try {
                            const response = await fetch('/api/open-folder', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ path: `statements/${statement.name}` })
                            });
                            const result = await response.json();
                            if (result.success) {
                                showToast(result.message, 'success');
                            } else {
                                showToast(result.error || 'Failed to open folder', 'error');
                            }
                        } catch (err) {
                            showToast('Error opening folder', 'error');
                            console.error(err);
                        }
                    };
                    tabsContainer.appendChild(btn);
                    
                    if (index === 0) {
                        currentStatement = statement.name;
                        currentStatementData = statement;
                        updateFolderLinks(statement);
                    }
                });
            } catch (error) {
                console.error('Error loading statements:', error);
            }
        }

        function updateFolderLinks(statement) {
            const folderLinksDiv = document.getElementById('folder-links');
            const receiptsLink = document.getElementById('receipts-folder-link');
            const matchedLink = document.getElementById('matched-folder-link');
            
            if (statement && statement.receipts_folder && statement.matched_folder) {
                folderLinksDiv.style.display = 'block';
                receiptsLink.href = '#';
                matchedLink.href = '#';
                
                // Add onclick to open in Finder (Mac) or Explorer (Windows)
                receiptsLink.onclick = async (e) => {
                    e.preventDefault();
                    try {
                        const response = await fetch('/api/open-folder', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ path: statement.receipts_folder })
                        });
                        const result = await response.json();
                        if (result.success) {
                            showToast(result.message, 'success');
                        } else {
                            showToast(result.error || 'Failed to open folder', 'error');
                        }
                    } catch (err) {
                        showToast('Error opening folder', 'error');
                        console.error(err);
                    }
                };
                matchedLink.onclick = async (e) => {
                    e.preventDefault();
                    try {
                        const response = await fetch('/api/open-folder', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ path: statement.matched_folder })
                        });
                        const result = await response.json();
                        if (result.success) {
                            showToast(result.message, 'success');
                        } else {
                            showToast(result.error || 'Failed to open folder', 'error');
                        }
                    } catch (err) {
                        showToast('Error opening folder', 'error');
                        console.error(err);
                    }
                };
            } else {
                folderLinksDiv.style.display = 'none';
            }
        }

        function selectStatement(statement, element) {
            currentStatement = statement.name;
            currentStatementData = statement;
            document.querySelectorAll('.statement-tab').forEach(t => t.classList.remove('active'));
            element.classList.add('active');
            updateFolderLinks(statement);
            updateUpdateButton();
            loadAll();
        }

        async function loadSummary() {
            try {
                const url = currentStatement 
                    ? `/api/summary?statement=${encodeURIComponent(currentStatement)}`
                    : '/api/summary';
                const response = await fetch(url);
                const data = await response.json();
                
                document.getElementById('stat-total').textContent = data.total || 0;
                document.getElementById('stat-matched').textContent = data.matched || 0;
                document.getElementById('stat-no-receipt').textContent = data.no_receipt_needed || 0;
                document.getElementById('stat-missing').textContent = data.missing || 0;
                document.getElementById('stat-completion').textContent = (data.completion_rate || 0) + '%';
                
                // Update completion card background
                updateCompletionBackground(data.completion_rate || 0);
                
                // Show "Update Learning" button if 100% complete
                const learnBtnCard = document.getElementById('learn-btn-card');
                if (data.completion_rate === 100 && currentStatement) {
                    learnBtnCard.style.display = 'block';
                    learnBtnCard.disabled = false;
                } else {
                    learnBtnCard.style.display = 'none';
                    learnBtnCard.disabled = true;
                }
            } catch (error) {
                console.error('Error loading summary:', error);
            }
        }

        async function loadTransactions(filter = 'all') {
            currentFilter = filter;
            
            try {
                const url = currentStatement
                    ? `/api/transactions?filter=${filter}&statement=${encodeURIComponent(currentStatement)}`
                    : `/api/transactions?filter=${filter}`;
                const response = await fetch(url);
                const transactions = await response.json();
                
                const tbody = document.getElementById('transactions-body');
                tbody.innerHTML = '';
                
                if (transactions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #86868b; padding: 40px;">No transactions found</td></tr>';
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('transactions-table').style.display = 'block';
                    return;
                }
                
                transactions.forEach(tx => {
                    const row = document.createElement('tr');
                    row.setAttribute('data-row', tx.row);
                    row.setAttribute('data-receipt', tx.receipt || '');
                    row.setAttribute('data-matched', tx.matched);
                    
                    // Add class if no receipt needed
                    if (tx.no_receipt_needed) {
                        row.classList.add('no-receipt-row');
                    }
                    
                    const amountClass = tx.amount.startsWith('-') ? 'negative' : 'positive';
                    
                    // Determine status badge
                    let statusBadge;
                    if (tx.matched) {
                        statusBadge = '<span class="badge matched">‚úì Matched</span>';
                    } else if (tx.no_receipt_needed) {
                        statusBadge = '<span class="badge no-receipt">‚óã No Receipt</span>';
                    } else {
                        statusBadge = '<span class="badge unmatched">‚úó Missing</span>';
                    }
                    
                    const merchantShort = extractMerchant(tx.description);
                    const invoiceUrl = getMerchantInvoiceUrl(merchantShort);
                    
                    // Show invoice button if URL exists, otherwise show "Learn URL" button
                    let invoiceButton = '';
                    if (invoiceUrl) {
                        const escapedMerchant = merchantShort
                            .replace(/\\/g, '\\\\')
                            .replace(/'/g, "\\'")
                            .replace(/"/g, '\\"')
                            .replace(/</g, '&lt;')
                            .replace(/>/g, '&gt;');
                        const escapedUrl = invoiceUrl
                            .replace(/\\/g, '\\\\')
                            .replace(/'/g, "\\'")
                            .replace(/"/g, '\\"');
                        invoiceButton = `<a href="${invoiceUrl}" target="_blank" class="invoice-btn" onclick="event.stopPropagation();">üìÑ Invoice</a><button class="edit-url-btn" onclick="event.stopPropagation(); showLearnUrlModal('${escapedMerchant}', '${escapedUrl}');">‚úèÔ∏è</button>`;
                    } else if (merchantShort && merchantShort !== 'Unknown' && merchantShort.length > 3) {
                        const escapedMerchant = merchantShort
                            .replace(/\\/g, '\\\\')
                            .replace(/'/g, "\\'")
                            .replace(/"/g, '\\"')
                            .replace(/</g, '&lt;')
                            .replace(/>/g, '&gt;');
                        invoiceButton = `<button class="learn-url-btn" onclick="event.stopPropagation(); showLearnUrlModal('${escapedMerchant}');">+ Learn URL</button>`;
                    }
                    
                    // Get ownership status - now supports both Mark and Flo being active
                    const ownerMark = tx.owner_mark || false;
                    const ownerFlo = tx.owner_flo || false;
                    const ownershipDisabled = tx.matched ? 'disabled' : '';
                    
                    row.innerHTML = `
                        <td>${tx.row}</td>
                        <td>${tx.date}</td>
                        <td class="amount ${amountClass}">‚Ç¨${tx.amount}</td>
                        <td class="description" onclick="showDescriptionModal('${tx.description.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"')}')">
                            <span class="merchant-short">${merchantShort || '(Internal)'}</span>${invoiceButton}
                        </td>
                        <td>${statusBadge}</td>
                        <td style="text-align: center;">
                            <div class="ownership-buttons-container">
                                <button class="ownership-btn ${ownerMark ? 'active' : ''} ${ownershipDisabled}" 
                                        onclick="toggleOwnerButton(${tx.row}, 'mark', event)">
                                    Mark
                                </button>
                                <button class="ownership-btn ${ownerFlo ? 'active' : ''} ${ownershipDisabled}" 
                                        onclick="toggleOwnerButton(${tx.row}, 'flo', event)">
                                    Flo
                                </button>
                            </div>
                        </td>
                        <td class="checkbox-cell">
                            <input type="checkbox" 
                                   ${tx.no_receipt_needed ? 'checked' : ''} 
                                   onchange="toggleNoReceipt(${tx.row}, this.checked)"
                                   ${tx.matched ? 'disabled' : ''}>
                        </td>
                        <td>
                            <div class="receipt-cell">
                                <span class="receipt-name">${tx.receipt || '-'}</span>
                                ${tx.receipt && tx.receipt !== '-' ? `<button class="delete-receipt-btn" onclick="deleteReceipt(${tx.row}, '${tx.receipt.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"')}', event)">‚úï</button>` : ''}
                            </div>
                        </td>
                    `;
                    
                    // Add drag-and-drop handlers
                    setupRowDragAndDrop(row);
                    
                    tbody.appendChild(row);
                });
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('transactions-table').style.display = 'block';
            } catch (error) {
                console.error('Error loading transactions:', error);
                document.getElementById('loading').innerHTML = '<p style="color: #ff3b30;">Error loading data</p>';
            }
        }

        async function loadReceipts() {
            try {
                const url = currentStatement
                    ? `/api/receipts?statement=${encodeURIComponent(currentStatement)}`
                    : '/api/receipts';
                const response = await fetch(url);
                const receipts = await response.json();
                
                const list = document.getElementById('receipts-list');
                list.innerHTML = '';
                
                if (receipts.length === 0) {
                    list.innerHTML = '<p style="text-align: center; color: #86868b; padding: 40px;">No receipts in folder</p>';
                    return;
                }
                
                receipts.forEach(receipt => {
                    const item = document.createElement('div');
                    item.className = 'file-item';
                    
                    const sizeKB = (receipt.size / 1024).toFixed(1);
                    const date = new Date(receipt.modified).toLocaleString();
                    
                    item.innerHTML = `
                        <div>
                            <div class="file-name">${receipt.name}</div>
                            <div class="file-meta">${sizeKB} KB ‚Ä¢ ${date}</div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="viewReceipt('${receipt.path}', '${receipt.name}')" class="download-link" style="background: #007aff; text-decoration: none; padding: 6px 12px; border: none; cursor: pointer;">View</button>
                            <a href="/api/download/${receipt.path}" class="download-link" download>Download</a>
                            <button onclick="deleteReceipt('${receipt.path}', '${receipt.name}')" class="download-link" style="background: #ff3b30; text-decoration: none; padding: 6px 12px; border: none; cursor: pointer;">Delete</button>
                        </div>
                    `;
                    
                    list.appendChild(item);
                });
            } catch (error) {
                console.error('Error loading receipts:', error);
            }
        }

        async function loadRenamedReceipts() {
            try {
                const url = currentStatement
                    ? `/api/renamed-receipts?statement=${encodeURIComponent(currentStatement)}`
                    : '/api/renamed-receipts';
                const response = await fetch(url);
                const receipts = await response.json();
                
                const list = document.getElementById('renamed-list');
                list.innerHTML = '';
                
                if (receipts.length === 0) {
                    list.innerHTML = '<p style="text-align: center; color: #86868b; padding: 40px;">No renamed receipts yet</p>';
                    return;
                }
                
                receipts.forEach(receipt => {
                    const item = document.createElement('div');
                    item.className = 'file-item';
                    
                    const sizeKB = (receipt.size / 1024).toFixed(1);
                    const date = new Date(receipt.modified).toLocaleString();
                    
                    item.innerHTML = `
                        <div>
                            <div class="file-name">${receipt.name}</div>
                            <div class="file-meta">${sizeKB} KB ‚Ä¢ ${date}</div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="viewReceipt('${receipt.path}', '${receipt.name}')" class="download-link" style="background: #007aff; text-decoration: none; padding: 6px 12px; border: none; cursor: pointer;">View</button>
                            <a href="/api/download/${receipt.path}" class="download-link" download>Download</a>
                            <button onclick="deleteReceipt('${receipt.path}', '${receipt.name}')" class="download-link" style="background: #ff3b30; text-decoration: none; padding: 6px 12px; border: none; cursor: pointer;">Delete</button>
                        </div>
                    `;
                    
                    list.appendChild(item);
                });
            } catch (error) {
                console.error('Error loading renamed receipts:', error);
            }
        }

        let allPoolReceipts = [];

        async function loadPool() {
            try {
                const response = await fetch('/api/pool');
                allPoolReceipts = await response.json();
                
                renderPool(allPoolReceipts);
            } catch (error) {
                console.error('Error loading pool:', error);
            }
        }

        function renderPool(receipts) {
            const list = document.getElementById('pool-list');
            list.innerHTML = '';
            
            if (receipts.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #86868b; padding: 40px;">No receipts in pool yet. Delete receipts and choose "Move to Pool" to add them here.</p>';
                return;
            }
            
            receipts.forEach(receipt => {
                const item = document.createElement('div');
                item.className = 'file-item';
                item.dataset.filename = receipt.name.toLowerCase();
                
                const sizeKB = (receipt.size / 1024).toFixed(1);
                const date = new Date(receipt.modified).toLocaleString();
                
                item.innerHTML = `
                    <div>
                        <div class="file-name">${receipt.name}</div>
                        <div class="file-meta">${sizeKB} KB ‚Ä¢ ${date}</div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="viewReceipt('${receipt.path}', '${receipt.name}')" class="download-link" style="background: #007aff; text-decoration: none; padding: 6px 12px; border: none; cursor: pointer;">View</button>
                        <a href="/api/download/${receipt.path}" class="download-link" download>Download</a>
                        <button onclick="assignFromPool('${receipt.path}', '${receipt.name}')" class="download-link" style="background: #34c759; text-decoration: none; padding: 6px 12px; border: none; cursor: pointer;">Assign</button>
                        <button onclick="deleteReceipt('${receipt.path}', '${receipt.name}')" class="download-link" style="background: #ff3b30; text-decoration: none; padding: 6px 12px; border: none; cursor: pointer;">Delete</button>
                    </div>
                `;
                
                list.appendChild(item);
            });
        }

        function filterPool() {
            const searchTerm = document.getElementById('pool-search').value.toLowerCase();
            
            if (!searchTerm) {
                renderPool(allPoolReceipts);
                return;
            }
            
            const filtered = allPoolReceipts.filter(receipt => 
                receipt.name.toLowerCase().includes(searchTerm)
            );
            
            renderPool(filtered);
        }

        async function assignFromPool(filepath, filename) {
            if (!currentStatement) {
                showToast('Please select a statement first', 'error');
                return;
            }
            
            showToast('This feature will be implemented next - drag and drop to transaction or select transaction', 'info');
            // TODO: Implement assign from pool
        }

        function setupRowDragAndDrop(row) {
            row.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                row.classList.add('drag-over');
            });
            
            row.addEventListener('dragleave', (e) => {
                e.preventDefault();
                e.stopPropagation();
                row.classList.remove('drag-over');
            });
            
            row.addEventListener('drop', async (e) => {
                e.preventDefault();
                e.stopPropagation();
                row.classList.remove('drag-over');
                
                const files = e.dataTransfer.files;
                if (files.length === 0) {
                    showToast('No files detected', 'error');
                    return;
                }
                
                if (files.length > 1) {
                    showToast('Please drop only one file at a time', 'error');
                    return;
                }
                
                const file = files[0];
                const rowNumber = row.getAttribute('data-row');
                const existingReceipt = row.getAttribute('data-receipt');
                const isMatched = row.getAttribute('data-matched') === 'true';
                
                // Check if row already has a receipt
                if (existingReceipt && existingReceipt !== '' && existingReceipt !== '-') {
                    // Show confirmation dialog
                    showReplaceDialog(rowNumber, file, existingReceipt);
                } else {
                    // No existing receipt, just assign
                    await assignReceiptToRow(rowNumber, file, 'replace');
                }
            });
        }

        async function assignReceiptToRow(rowNumber, file, action = 'replace') {
            if (!currentStatement) {
                showToast('Please select a statement first', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('statement', currentStatement);
            formData.append('row', rowNumber);
            formData.append('action', action);
            
            try {
                showToast('Assigning receipt...', 'success');
                
                const response = await fetch('/api/assign-receipt', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast(`‚úì Receipt assigned to row ${rowNumber}`, 'success');
                    loadAll(); // Reload all data
                    checkUndoAvailable(); // Update undo button state
                } else {
                    showToast(data.error || 'Failed to assign receipt', 'error');
                }
            } catch (error) {
                console.error('Error assigning receipt:', error);
                showToast('Error assigning receipt', 'error');
            }
        }

        function showReplaceDialog(rowNumber, file, existingReceipt) {
            const modal = document.getElementById('replace-modal');
            const message = document.getElementById('replace-message');
            const replaceBtn = document.getElementById('replace-delete-btn');
            const restoreBtn = document.getElementById('replace-restore-btn');
            const cancelBtn = document.getElementById('replace-cancel-btn');
            
            message.textContent = `Row ${rowNumber} already has receipt: ${existingReceipt}`;
            
            replaceBtn.onclick = async () => {
                modal.style.display = 'none';
                await assignReceiptToRow(rowNumber, file, 'replace');
            };
            
            restoreBtn.onclick = async () => {
                modal.style.display = 'none';
                await assignReceiptToRow(rowNumber, file, 'restore');
            };
            
            cancelBtn.onclick = () => {
                modal.style.display = 'none';
            };
            
            modal.style.display = 'flex';
        }

        function switchTab(tab, element) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            element.classList.add('active');
            
            document.getElementById('transactions-section').style.display = 'none';
            document.getElementById('receipts-section').style.display = 'none';
            document.getElementById('renamed-section').style.display = 'none';
            document.getElementById('pool-section').style.display = 'none';
            
            if (tab === 'receipts') {
                document.getElementById('receipts-section').style.display = 'block';
                loadReceipts();
            } else if (tab === 'renamed') {
                document.getElementById('renamed-section').style.display = 'block';
                loadRenamedReceipts();
            } else if (tab === 'pool') {
                document.getElementById('pool-section').style.display = 'block';
                loadPool();
            } else {
                document.getElementById('transactions-section').style.display = 'block';
                loadTransactions(tab);
            }
        }

        async function toggleOwnerButton(row, owner, event) {
            event.preventDefault();
            event.stopPropagation();
            
            if (!currentStatement) {
                showToast('Please select a statement first', 'error');
                return;
            }

            const button = event.currentTarget;
            if (button.classList.contains('disabled')) {
                return; // Don't allow toggling if matched
            }

            // Toggle the button state
            const isActive = button.classList.contains('active');
            const newState = !isActive;

            try {
                const response = await fetch('/api/set-ownership', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        statement: currentStatement,
                        row: row,
                        owner: owner,  // 'mark' or 'flo'
                        active: newState
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    const ownerName = owner.charAt(0).toUpperCase() + owner.slice(1);
                    const action = newState ? 'assigned to' : 'removed from';
                    showToast(`${ownerName} ${action} transaction`, 'success');
                    loadAll(); // Reload data
                } else {
                    showToast(data.error || 'Failed to update ownership', 'error');
                }
            } catch (error) {
                console.error('Error setting ownership:', error);
                showToast('Error updating ownership', 'error');
            }
        }

        async function deleteReceipt(row, filename, event) {
            event.preventDefault();
            event.stopPropagation();
            
            if (!currentStatement) {
                showToast('Please select a statement first', 'error');
                return;
            }
            
            if (!confirm(`Remove receipt "${filename}" from row ${row}?\n\nThe file will be moved back to the receipts folder.`)) {
                return;
            }
            
            try {
                showToast('Removing receipt...', 'success');
                
                const response = await fetch('/api/delete-receipt-assignment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        statement: currentStatement,
                        row: row,
                        filename: filename
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast(`‚úì Receipt removed from row ${row}`, 'success');
                    loadAll();
                    checkUndoAvailable();
                } else {
                    showToast(data.error || 'Failed to remove receipt', 'error');
                }
            } catch (error) {
                console.error('Error deleting receipt:', error);
                showToast('Error removing receipt', 'error');
            }
        }

        async function toggleNoReceipt(row, checked) {
            try {
                const response = await fetch('/api/toggle-no-receipt', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        statement: currentStatement,
                        row: row,
                        checked: checked
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast(checked ? 'Marked: No receipt needed' : 'Unmarked: Receipt needed', 'success');
                    // Refresh data
                    loadAll();
                } else {
                    showToast(data.error || 'Failed to update', 'error');
                }
            } catch (error) {
                console.error('Error toggling no receipt:', error);
                showToast('Failed to update', 'error');
            }
        }

        async function runMatching() {
            if (!currentStatement) {
                showToast('Please select a statement first', 'error');
                return;
            }
            
            const updateBtn = document.getElementById('update-btn');
            const btnText = document.getElementById('update-btn-text');
            const btnSpinner = document.getElementById('update-btn-spinner');
            const progress = document.getElementById('match-progress');
            
            // Disable button and show spinner
            updateBtn.disabled = true;
            btnText.style.display = 'none';
            btnSpinner.style.display = 'inline';
            progress.textContent = 'Scanning receipts and matching...';
            
            try {
                const response = await fetch('/api/match-receipts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        statement: currentStatement
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast(data.message, 'success');
                    progress.textContent = `‚úì Matched ${data.matched} of ${data.total_receipts} receipts`;
                    
                    // Refresh all data
                    await loadAll();
                    
                    // Clear progress after 3 seconds
                    setTimeout(() => {
                        progress.textContent = '';
                    }, 3000);
                } else {
                    showToast(data.error || 'Matching failed', 'error');
                    progress.textContent = '‚úó Matching failed';
                }
            } catch (error) {
                console.error('Error running matching:', error);
                showToast('Matching failed: ' + error.message, 'error');
                progress.textContent = '‚úó Error occurred';
            } finally {
                // Re-enable button
                updateBtn.disabled = false;
                btnText.style.display = 'inline';
                btnSpinner.style.display = 'none';
            }
        }

        async function clearStatement() {
            if (!currentStatement) {
                showToast('Please select a statement first', 'error');
                return;
            }
            
            // Confirmation dialog
            if (!confirm(`Are you sure you want to CLEAR/RESET this statement?\n\n"${currentStatement}"\n\nThis will:\n‚Ä¢ Move all matched receipts back to receipts folder\n‚Ä¢ Delete all match data\n\nYou can re-run matching afterwards.`)) {
                return;
            }
            
            const clearBtn = document.getElementById('clear-btn');
            const progress = document.getElementById('match-progress');
            
            clearBtn.disabled = true;
            progress.textContent = 'Resetting statement...';
            
            try {
                const response = await fetch('/api/clear-statement', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        statement: currentStatement,
                        confirm: true
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast(data.message, 'success');
                    progress.textContent = `‚úì Reset complete: ${data.receipts_moved} receipts moved back`;
                    
                    // Refresh all data
                    await loadAll();
                    
                    setTimeout(() => {
                        progress.textContent = '';
                    }, 3000);
                } else {
                    showToast(data.error || 'Clear failed', 'error');
                    progress.textContent = '‚úó Clear failed';
                }
            } catch (error) {
                console.error('Error clearing statement:', error);
                showToast('Clear failed: ' + error.message, 'error');
                progress.textContent = '‚úó Error occurred';
            } finally {
                clearBtn.disabled = false;
            }
        }

        async function deleteStatement() {
            if (!currentStatement) {
                showToast('Please select a statement first', 'error');
                return;
            }
            
            // Confirmation dialog
            if (!confirm(`‚ö†Ô∏è WARNING: You are about to DELETE this statement and ALL associated data!\n\n"${currentStatement}"\n\nThis will PERMANENTLY delete:\n‚Ä¢ The statement file\n‚Ä¢ All receipts in the folder\n‚Ä¢ All matched receipts\n‚Ä¢ All match data\n\nThis action CANNOT be undone!\n\nAre you sure you want to continue?`)) {
                return;
            }
            
            const deleteBtn = document.getElementById('delete-btn');
            const progress = document.getElementById('match-progress');
            
            deleteBtn.disabled = true;
            progress.textContent = 'Deleting statement...';
            
            try {
                const response = await fetch('/api/delete-statement', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        statement: currentStatement,
                        confirm: true
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast(data.message, 'success');
                    progress.textContent = `‚úì Statement deleted`;
                    
                    // Clear current statement
                    currentStatement = null;
                    
                    // Reload statements list
                    await loadStatements();
                    await loadAll();
                    
                    setTimeout(() => {
                        progress.textContent = '';
                    }, 3000);
                } else {
                    showToast(data.error || 'Delete failed', 'error');
                    progress.textContent = '‚úó Delete failed';
                }
            } catch (error) {
                console.error('Error deleting statement:', error);
                showToast('Delete failed: ' + error.message, 'error');
                progress.textContent = '‚úó Error occurred';
            } finally {
                deleteBtn.disabled = false;
            }
        }

        async function updateLearning() {
            if (!currentStatement) {
                showToast('Please select a statement first', 'error');
                return;
            }
            
            if (!confirm('Update learning model with this statement?\n\nThis will use all matched receipts to improve future recognition accuracy.')) {
                return;
            }
            
            try {
                showToast('Updating learning model...', 'success');
                
                const response = await fetch('/api/update-learning', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        statement: currentStatement
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast(`‚úì Learning updated! Processed ${data.receipts_processed} receipts`, 'success');
                } else {
                    showToast(data.error || 'Failed to update learning', 'error');
                }
            } catch (error) {
                console.error('Error updating learning:', error);
                showToast('Error updating learning', 'error');
            }
        }

        function updateUpdateButton() {
            const updateBtn = document.getElementById('update-btn');
            const headerUndoBtn = document.getElementById('header-undo-btn');
            const clearBtn = document.getElementById('clear-btn');
            const deleteBtn = document.getElementById('delete-btn');
            
            if (currentStatement) {
                updateBtn.disabled = false;
                clearBtn.disabled = false;
                deleteBtn.disabled = false;
                checkUndoAvailable(); // Check if undo is available
            } else {
                updateBtn.disabled = true;
                if (headerUndoBtn) headerUndoBtn.disabled = true;
                clearBtn.disabled = true;
                deleteBtn.disabled = true;
            }
        }
        
        async function checkUndoAvailable() {
            if (!currentStatement) return;
            
            try {
                const response = await fetch(`/api/undo-history?statement=${encodeURIComponent(currentStatement)}`);
                const data = await response.json();
                
                const headerUndoBtn = document.getElementById('header-undo-btn');
                
                if (headerUndoBtn) {
                    headerUndoBtn.disabled = data.count === 0;
                    if (data.count > 0) {
                        headerUndoBtn.textContent = `‚Ü∂ Undo (${data.count})`;
                    } else {
                        headerUndoBtn.textContent = '‚Ü∂ Undo';
                    }
                }
            } catch (error) {
                console.error('Error checking undo availability:', error);
            }
        }
        
        async function undoLastAction() {
            if (!currentStatement) {
                showToast('Please select a statement first', 'error');
                return;
            }
            
            try {
                showToast('Undoing last action...', 'success');
                
                const response = await fetch('/api/undo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        statement: currentStatement
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast(data.message, 'success');
                    loadAll(); // Reload all data
                    checkUndoAvailable(); // Update undo button state
                } else {
                    showToast(data.error || 'Failed to undo', 'error');
                }
            } catch (error) {
                console.error('Error undoing action:', error);
                showToast('Error undoing action', 'error');
            }
        }

        function loadAll() {
            loadSummary();
            loadTransactions(currentFilter);
            updateUpdateButton();
        }

        window.onload = function() {
            loadStatements().then(() => {
                loadAll();
            });
            
            setInterval(() => {
                if (currentFilter !== 'receipts' && currentFilter !== 'renamed') {
                    loadSummary();
                }
            }, 10000);
        };
    </script>
</body>
</html>
